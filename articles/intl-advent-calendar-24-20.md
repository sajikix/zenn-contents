---
title: "Intl.Segmenter(#20)"
emoji: "ğŸ”ª"
type: "tech"
topics: ["Intl", "i18n", "frontend"]
published: true
---

ã“ã®è¨˜äº‹ã¯ã€Œ[1 äºº Intl Advent Calendar 2024](https://adventar.org/calendars/10555)ã€ã® 20 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

ä»Šå›ã¯å˜èªã‚„è¦‹ãŸç›®ã®ï¼‘æ–‡å­—ã€æ–‡å˜ä½ã§æ–‡å­—åˆ—ã‚’åˆ†å‰²ã§ãã‚‹ `Intl.Segmenter` ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## `Intl.Segmenter`

`Intl.Segmenter` ã¯ãƒ­ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®ã—ã¤ã¤ã€æŒ‡å®šã•ã‚ŒãŸç²’åº¦ã§æ–‡å­—åˆ—ã‚’åˆ†å‰²ã™ã‚‹ãŸã‚ã® API ã§ã™ã€‚

### Intl.Segmenter ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹

ä»–ã® Intl ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åŒæ§˜ã€ç¬¬ï¼‘å¼•æ•°ã«ãƒ­ã‚±ãƒ¼ãƒ«(ãƒ­ã‚±ãƒ¼ãƒ«è­˜åˆ¥å­ or Intl.Locale ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ã‚’ç¬¬ï¼’å¼•æ•°ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦åˆæœŸåŒ–ã™ã‚‹ã“ã¨ã§ã€Intl.Segmenter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚

```ts
const segmenter = new Intl.Segmenter("ja-JP", {
  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®š
});
```

ç”Ÿæˆã—ãŸ Intl.Segmenter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ `segment()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒç”Ÿãˆã¦ãŠã‚Š(è©³ã—ãã¯è¨˜è¿°)ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«åˆ†å‰²ã—ãŸã„æ–‡å­—åˆ—ã‚’æ¸¡ã™ã“ã¨ã§åˆ†å‰²ã•ã‚ŒãŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```ts
const segments = new Intl.Segmenter("ja-JP").segment("ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚");
console.log([...segments]); // ["ã“ã‚“ã«ã¡ã¯", "ã€", "ä¸–ç•Œ", "ã€‚"]
```

### ãƒ¡ã‚½ãƒƒãƒ‰

Intl.Segmenter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ä»¥ä¸‹ã® 2 ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

- `segment()`
- `resolvedOptions()`(ä»–ã® Intl ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨åŒæ§˜ãªã®ã§çœç•¥)

#### `segment()` ãƒ¡ã‚½ãƒƒãƒ‰

`segment()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ–‡å­—åˆ—ã‚’æŒ‡å®šã•ã‚ŒãŸç²’åº¦ã§åˆ†å‰²ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚è¿”ã‚Šå€¤ã¯åˆ†å‰²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åå¾©å¯èƒ½ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ä¿æŒã™ã‚‹ Intl.Segments ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ã€‚

```ts
const segments = new Intl.Segmenter("ja-JP", { granularity: "word" }).segment(
  "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚"
); // Intl.Segments ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
```

Intl.Segments ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯åå¾©å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãªã®ã§ã€`for...of` æ§‹æ–‡ã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ¼”ç®—å­ã‚’ä½¿ã£ã¦å±•é–‹ã§ãã¾ã™ã€‚

```ts
console.log([...segments]);
// [
//     { "segment": "ã“ã‚“ã«ã¡ã¯", "index": 0, "input": "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚", "isWordLike": true},
//     { "segment": "ã€", "index": 5, "input": "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚", "isWordLike": false},
//     { "segment": "ä¸–ç•Œ", "index": 6, "input": "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚", "isWordLike": true},
//     { "segment": "ã€‚", "index": 8, "input": "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚", "isWordLike": false}
// ]
```

å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¾ã™ã€‚

- `segment`: åˆ†å‰²ã•ã‚ŒãŸæ–‡å­—åˆ—
- `index`: å…ƒã®æ–‡å­—åˆ—ã«ãŠã‘ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®é–‹å§‹ä½ç½®
- `input`: å…ƒã®æ–‡å­—åˆ—
- `isWordLike`: åˆ†å‰²ã•ã‚ŒãŸæ–‡å­—åˆ—ãŒãƒ¯ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã®çœŸå½å€¤
  - (`granularity` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒ `"word"` ã®æ™‚ã®ã¿)

ã¾ãŸ Intl.Segments ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ `containing()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒç”Ÿãˆã¦ãŠã‚Šã€æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«å«ã¾ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã§ãã¾ã™ã€‚`containing()` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã‚Šå€¤ã¯ä¸Šè¨˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã¨åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

```ts
const segments = new Intl.Segmenter("ja-JP", { granularity: "word" }).segment(
  "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚"
);
console.log(segments.containing(3)); // { "segment": "ã“ã‚“ã«ã¡ã¯", "index": 0, "input": "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚", "isWordLike": true}
console.log(segments.containing(7)); // { "segment": "ä¸–ç•Œ", "index": 6, "input": "ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œã€‚", "isWordLike": true}
```

`containing()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ `undefined` ã‚’è¿”ã—ã¾ã™ã€‚

### Intl.Segmenter ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

Intl.Segmenter ã®åˆæœŸåŒ–ã§æŒ‡å®šã§ãã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å…±é€šã® `localeMatcher` ã‚’é™¤ãã¨ã€`granularity` ã® 1 ã¤ã ã‘ã§ã™ã€‚

#### `granularity` ã‚ªãƒ—ã‚·ãƒ§ãƒ³

`granularity` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯åˆ†å‰²ã™ã‚‹ç²’åº¦ã‚’æŒ‡å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚æŒ‡å®šå¯èƒ½ãªå€¤ã¯ `"grapheme"`, `"word"`, `"sentence"` ã®ã„ãšã‚Œã‹ã§ã™ã€‚

##### `"grapheme"` ã‚’æŒ‡å®šã—ãŸæ™‚

`"grapheme"` ã‚’æŒ‡å®šã™ã‚‹ã¨ Intl.Segmenter ã¯ã€Œè¦‹ãŸç›®ä¸Šã® 1 æ–‡å­—(ã‚«ãƒ¼ã‚½ãƒ«ãŒ 1 ã¤å‹•ãåˆ†)ã€ã§å…¥åŠ›æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªä¸€æ–‡å­—ã®å˜ä½ã‚’æ›¸è¨˜ç´ (grapheme)ã¨å‘¼ã³ã¾ã™ã€‚

ã€Œæ–‡å­—ã”ã¨ã«åˆ†å‰²ã™ã‚‹ã€ã¨èãã¨ç°¡å˜ãã†ã«èã“ãˆã¾ã™ãŒã€å®Ÿéš›ã«ã€Œè¦‹ãŸç›®ä¸Šã® 1 æ–‡å­—ã€ã§åˆ†å‰²ã™ã‚‹ã®ã¯ã‹ãªã‚Šé›£ã—ã„å•é¡Œã§ã™ã€‚

ãã‚‚ãã‚‚ JavaScript ã«ãŠã„ã¦æ–‡å­—åˆ—ã¯å†…éƒ¨çš„ã« UTF-16 ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¾ã™ãŒã€UTF16 ã«ãŠã‘ã‚‹åŸºæœ¬å˜ä½ã® 2 ãƒã‚¤ãƒˆã§è¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ãŒè¡¨ç¾ã•ã‚Œã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚

- ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã‚’åˆ©ç”¨ã—ãŸæ–‡å­— : ä¾‹) ğ©¸½
- ç•°ä½“å­—ã‚»ãƒ¬ã‚¯ã‚¿ã‚’åˆ©ç”¨ã—ãŸæ–‡å­— : ä¾‹) è‚Œã®è‰²ã®é•ã†çµµæ–‡å­—
- çµåˆæ–‡å­—ã¨å‰ã«ã‚ã‚‹æ–‡å­—ã®çµ„ã¿åˆã‚ã› : ä¾‹) Ìˆ + o = Ã¶
- ZWJ ã‚’åˆ©ç”¨ã—ãŸè¤‡æ•°æ–‡å­—ã®çµåˆ : ä¾‹) ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦

JS ã®æ–‡å­—åˆ—ã«ã‚ã‚‹ `length` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ 16bit ã‚’ 1 å˜ä½ã¨ã—ã¦è¨ˆç®—ã™ã‚‹ã®ã§ã€å¿…ãšã—ã‚‚ã€Œè¦‹ãŸç›®ã®ä¸€æ–‡å­— = String ã®ã€€`length`ã€€å€¤ã€ã«ãªã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã—ã€`length` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã£ã¦æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ã¦ã€Œè¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ã€ã«ãªã‚‰ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```ts
console.log("ğ©¸½".length); // 2
console.log("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦".length); // 11
```

ã¾ãŸæ–‡å­—åˆ—ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¯ CodePoint å˜ä½ã§åå¾©å‡¦ç†ã™ã‚‹ã®ã§ã€fo-of æ–‡ã‚„ spreadOperator ã‚’ä½¿ãˆã° CodePoint å˜ä½ã§ä¸€æ„ãªæ–‡å­—(ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã§è¡¨ç¾ã•ã‚Œã‚‹ã‚ˆã†ãªã‚‚ã®)ã¯ 1 ã¤ã®æ–‡å­—ã¨ã—ã¦åˆ†å‰²ã§ãã¾ã™ã€‚ãã‚Œã§ã‚‚ç•°ä½“å­—ã‚»ãƒ¬ã‚¯ã‚¿ã‚„çµåˆæ–‡å­—ã€ZWJ ãªã©ã‚’åˆ©ç”¨ã—ãŸæ–‡å­—ã¯ 1 æ–‡å­—ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã§ãã¾ã›ã‚“ã€‚

```ts
console.log([..."ğ©¸½"].length); // 2
console.log([..."ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"].length); // 7
```

ã“ã®ã‚ˆã†ãªã€Œ1 æ–‡å­—ã‚’ã©ã†æ‰±ã†ã‹ã€ã®å•é¡Œã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒè©³ã—ã„ã§ã™ã€‚

https://blog.jxck.io/entries/2017-03-02/unicode-in-javascript.html

ã“ã®ã‚ˆã†ã«ã€Œè¦‹ãŸç›®ä¸Šã® 1 æ–‡å­—ã€ã§åˆ†å‰²ã™ã‚‹ã“ã¨ãŒæ€ã£ãŸã‚ˆã‚Šé›£ã—ã„ã“ã¨ã¯ç†è§£ã„ãŸã ã‘ãŸã¨æ€ã„ã¾ã™ãŒã€`Intl.Segmenter` ã§ã‚ã‚Œã°ã“ã®å•é¡Œã‚’è§£æ±ºã§ãã¾ã™ã€‚`Intl.Segmenter` ã§ `granularity` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« `"grapheme"` ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€ [Unicode ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](https://unicode.org/reports/tr29/)ã‚’åˆ©ç”¨ã—ã€Œè¦‹ãŸç›®ä¸Šã® 1 æ–‡å­—ã€ã§ã®åˆ†å‰²ã‚’ãŠã“ãªã„ã¾ã™ã€‚

```ts
const segmenter = new Intl.Segmenter("ja-JP", { granularity: "grapheme" });
console.log([...segmenter.segment("ğ©¸½")].length); // 1
console.log([...segmenter.segment("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦")].length); // 1
```

ã“ã®å‡¦ç†ã§ã¯ã€ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã‚„ç•°ä½“å­—ã‚»ãƒ¬ã‚¯ã‚¿ã€çµåˆæ–‡å­—ã€ZWJ ãªã©ã‚’åˆ©ç”¨ã—ãŸæ–‡å­—ã‚‚ã€Œè¦‹ãŸç›®ä¸Šã® 1 æ–‡å­—ã€ã¨ã—ã¦æ­£ã—ãåˆ†å‰²ã•ã‚Œã¾ã™ã€‚

##### `"word"` ã‚’æŒ‡å®šã—ãŸæ™‚

`"word"` ã‚’æŒ‡å®šã™ã‚‹ã¨ Intl.Segmenter ã¯ã€Œå˜èªã€ã§å…¥åŠ›æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå˜èªã®å˜ä½ã¯ãƒ­ã‚±ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ã«ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚„å¥èª­ç‚¹ã§åŒºåˆ‡ã‚‰ã‚ŒãŸæ–‡å­—åˆ—ã‚’å˜èªã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

```ts
const enSegmenter = new Intl.Segmenter("en-US", { granularity: "word" });
console.log([...enSegmenter.segment("Hello, world!")]);
// åˆ†å‰²ã‚¤ãƒ¡ãƒ¼ã‚¸ : ["Hello", ",", " ", "world", "!"]
```

ãƒ­ã‚±ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ã¯å˜èªé–“ã«ã‚¹ãƒšãƒ¼ã‚¹ãŒå…¥ã‚‰ãªã„è¨€èªã‚‚ã‚ã‚Šã¾ã™ãŒã€ãã®ã‚ˆã†ãªè¨€èªã«å¯¾ã—ã¦ã‚‚ã‚ã‚‹ç¨‹åº¦ã®ç²¾åº¦ã§å˜èªã‚’åˆ†å‰²ã§ãã¾ã™ã€‚ã“ã®å®Ÿè£…ã«é–¢ã—ã¦ã¯åˆ¥ã«ä»¥ä¸‹ã®è¨˜äº‹ã‚’æ›¸ã„ãŸã®ã§ãœã²èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

https://zenn.dev/cybozu_frontend/articles/explore-intl-segmenter

##### `"sentence"` ã‚’æŒ‡å®šã—ãŸæ™‚

`"sentence"` ã‚’æŒ‡å®šã™ã‚‹ã¨ Intl.Segmenter ã¯ã€Œæ–‡ã€ã§å…¥åŠ›æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªæ–‡ã®å˜ä½ã¯ãƒ­ã‚±ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ã«ã¯ãƒ”ãƒªã‚ªãƒ‰ã‚„æ”¹è¡Œæ–‡å­—ã§åŒºåˆ‡ã‚‰ã‚ŒãŸæ–‡å­—åˆ—ã‚’æ–‡ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

```ts
const enSegmenter = new Intl.Segmenter("en-US", { granularity: "sentence" });
console.log([...enSegmenter.segment("Hello, world! How are you?")]);
// åˆ†å‰²ã‚¤ãƒ¡ãƒ¼ã‚¸ : ["Hello, world!","How are you?"]
```

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

#### å…ˆé ­æ–‡å­—ã‚’åˆ©ç”¨ã™ã‚‹ UIãƒ»è¡¨ç¾

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®åˆæœŸã‚¢ã‚¤ã‚³ãƒ³ã¨ã—ã¦ã€åå‰ã®å…ˆé ­æ–‡å­—ã‚’åˆ©ç”¨ã™ã‚‹ UI ã¯ã—ã°ã—ã°è¦‹ã‹ã‘ã¾ã™ã€‚ä¾‹ãˆã° Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åˆæœŸã‚¢ã‚¤ã‚³ãƒ³ãªã©ã¯åå‰ã®å…ˆé ­æ–‡å­—ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

![ç­†è€…ã®googleã®åˆæœŸã‚¢ã‚¤ã‚³ãƒ³](/images/intlAdventCalendar24_20/googleIcon.png)

ã“ã®ã‚ˆã†ãª UI ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€è¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ç›®ã‚’ã€Œæ­£ç¢ºã«ã€æŠœãå‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å‰ç« ã® `granularity` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚‚æ›¸ã„ãŸã‚ˆã†ã«ã€è¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ã‚’æ­£ç¢ºã«æŠœãå‡ºã™ã®ã¯æ¡ˆå¤–ã‚€ãšã‹ãã€å®Ÿéš›å¤šãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã‚’åˆ©ç”¨ã—ãŸæ–‡å­—ã‚„ ZWJ ã‚’åˆ©ç”¨ã—ãŸè¤‡æ•°æ–‡å­—ã‚’çµåˆã—ãŸæ–‡å­—ã«å¯¾å¿œã§ããªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã— `Intl.Segmenter` ã‚’åˆ©ç”¨ã™ã‚Œã°ã“ã®å•é¡Œã‚’è§£æ±ºã§ãã¾ã™ã€‚

```ts
const getFistCharacter = (name: string) => {
  const segmenter = new Intl.Segmenter("ja-JP", { granularity: "grapheme" });
  return [...segmenter.segment(name)][0].segment;
};
```

#### æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚„é©åˆ‡ã«

åŒæ§˜ã«ã€Œè¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ç›®ã‚’æ­£ç¢ºã«åˆ†å‰²ã§ãã‚‹ã€æ©Ÿèƒ½ã¯æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚„é©åˆ‡ãª truncate ã«ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚

ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã«ã¯ã‚ã‚‰ã‹ã˜ã‚æ–‡å­—æ•°åˆ¶é™ã®ã‚ã‚‹å ´åˆãŒã»ã¨ã‚“ã©ã§ã™ãŒã€ã“ã®æ–‡å­—æ•°ã‚’ãƒ‡ãƒ¼ã‚¿ä¸Šã®å˜ä½ã¨ã™ã‚‹ã‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦‹ãŸç›®ã®æ–‡å­—æ•°ã¨ã™ã‚‹ã‹ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã“ã¨ãªã©ã‚’è€ƒãˆã†ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ä¸Šã®å˜ä½(ä¾‹ãˆã°ï¼’ãƒã‚¤ãƒˆã§ï¼‘æ–‡å­—åˆ†ã¨ã™ã‚‹)ã§ã‚‚è‰¯ã„ã‹ã‚‚å…¥ã‚Œã¾ã›ã‚“ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ›¸ã„ãŸæ–‡å­—æ•°ã®ãƒã‚¤ãƒˆæ•°ãªã©æ°—ã«ã—ã¦ã„ãªã„ã®ã§ã€Œæ›¸ã„ã¦ã‚ã‚‹ã‚ˆã‚Šã‚‚æ—©ãæ–‡å­—æ•°åˆ¶é™ãŒæ¥ã‚‹ã€ã‚ˆã†ã«æ„Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šé™å€¤ãŒæ•°ç™¾æ–‡å­—ãªã©ã§ã‚ã‚Œã°ãã«ãªã‚‰ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã‚¿ã‚¤ãƒˆãƒ«ã®å…¥åŠ›ãªã©ä¸Šé™æ–‡å­—æ•°ãŒå°‘ãªã„å ´åˆã¯ã“ã®å•é¡ŒãŒé¡•è‘—ã«ãªã‚Šã¾ã™ã€‚

```ts
const LIMIT = 10;
const validateLengthLimit = (text: string) => {
  return text.length <= LIMIT ? "OK" : "NG";
};
console.log(validateLengthLimit("ã‚ã„ã†ãˆãŠã‹ããã‘ã“")); // "OK"
console.log(validateLengthLimit("ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦")); // "NG
// ã€Œä¸Šé™10æ–‡å­—ãªã®ã«ï¼‘æ–‡å­—ã§ã‚¢ã‚¦ãƒˆã£ã¦ã©ã†ã„ã†ã“ã¨ï¼Ÿã€ã£ã¦ãªã‚Šãã†ãªä¾‹
```

ã“ã®ã‚ˆã†ãªå ´åˆã€è¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ã‚’æ­£ç¢ºã«åˆ†å‰²ã§ãã‚‹ `Intl.Segmenter` ã‚’åˆ©ç”¨ã—ã¦æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ„Ÿã˜ã‚‹æ–‡å­—æ•°ã¨ãƒ‡ãƒ¼ã‚¿ä¸Šã®æ–‡å­—æ•°ã‚’ä¸€è‡´ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const LIMIT = 10;
const validateLengthLimit = (text: string) => {
  const segmenter = new Intl.Segmenter("ja-JP", { granularity: "grapheme" });
  return [...segmenter.segment(text)].length <= LIMIT ? "OK" : "NG";
};
console.log(validateLengthLimit("ã‚ã„ã†ãˆãŠã‹ããã‘ã“")); // "OK"
console.log(validateLengthLimit("ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦")); // "OK"
```

#### æ–‡å­—åˆ—ã® truncate

ã‚¹ãƒšãƒ¼ã‚¹ã®é–¢ä¿‚ãªã©ã§æ–‡å­—åˆ—å…¨ä½“ã‚’è¡¨ç¤ºã§ããªã„å ´åˆã€`ã€Œã“ã®è¨˜äº‹ã¯...ã€` ã®ã‚ˆã†ã«çœç•¥ã—ã¦è¡¨ç¤ºã™ã‚‹ truncate ãŒã‚ˆãåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãª truncate å‡¦ç†ã¯ãã‚‚ãã‚‚è¡¨ç¤ºé ˜åŸŸã«åã¾ã‚‹ã‚ˆã†ã«çœç•¥ã™ã‚‹ã‚ã‘ã§ã™ãŒã‹ã‚‰ã€è¦‹ãŸç›®ä¸Šã®æ–‡å­—æ•°ã§ã‚«ã‚¦ãƒ³ãƒˆã—ã¦çœç•¥ã—ã¦ã»ã—ã„ã¨ã“ã‚ã§ã™ã€‚æ„å›³ã—ãŸè¡¨ç¤ºã‚ˆã‚ŠçŸ­ããªã‚‹(çœç•¥ã•ã‚Œã™ãã‚‹)ã ã‘ãªã‚‰ã¾ã è‰¯ã„ã§ã™ãŒã€è¦‹ãŸç›®ä¸Šã®ï¼‘æ–‡å­—ã‚’æ­£ç¢ºã«åˆ†å‰²ã§ããªã„ã¨æ–‡å­—åŒ–ã‘ã‚„æ„å‘³ä¸æ˜ãªæ–‡å­—åˆ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚

```ts
const LIMIT = 10;
const badTruncate = (text: string) => {
  return text.length <= limit ? text : text.slice(0, limit) + "...";
};
console.log(badTruncate("ğŸ‡¯ğŸ‡µ vs ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ã“ã®å¾Œã™ãï¼")); // "ğŸ‡¯ğŸ‡µ vs ğŸ´..."
// è¬ã®ã€ŒğŸ´ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
```

ã“ã®ã‚ˆã†ãªå•é¡Œã‚‚ `Intl.Segmenter` ã‚’åˆ©ç”¨ã™ã‚Œã°è§£æ±ºã§ãã¾ã™ã€‚

```ts
const LIMIT = 10;
const goodTruncate = (text: string) => {
  const segmenter = new Intl.Segmenter("ja-JP", { granularity: "grapheme" });
  const segments = [...segmenter.segment(text)];
  return segments.length <= LIMIT
    ? text
    : segments
        .slice(0, LIMIT)
        .map((segment) => segment.segment)
        .join("") + "...";
};
console.log(goodTruncate("ğŸ‡¯ğŸ‡µ vs ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ã“ã®å¾Œã™ãï¼")); // "ğŸ‡¯ğŸ‡µ vs ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ã“ã®å¾Œ..."
```

#### æ–‡ãƒ¬ãƒ™ãƒ«ã®çœç•¥

é•·ã„æ–‡ç« ã‚’çœç•¥ã—ã¦è¡¨ç¤ºã™ã‚‹éš›ã«ã€é€”ä¸­ã®æ–‡ã‚’çœç•¥ã—ã¦è¡¨è¨˜ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚æ—¥æœ¬èªã§ã‚ã‚Œã°ã€Œ(ä¸­ç•¥)ã€ã¨ã„ã£ãŸè¡¨ç¾ã‚’ä½¿ã†ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚

```
ã“ã®è¨˜äº‹ã§ã¯ Intl.Segmenter ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚(ä¸­ç•¥)ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
```

ã“ã®ã‚ˆã†ãªæ–‡ãƒ¬ãƒ™ãƒ«ã®çœç•¥ã‚‚ `Intl.Segmenter` ã‚’åˆ©ç”¨ã™ã‚Œã°æ­£ç¢ºã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const truncateSentence = (text: string) => {
  const segmenter = new Intl.Segmenter("ja-JP", { granularity: "sentence" });
  const segments = [...segmenter.segment(text)];
  return segments[0].segment + "(ä¸­ç•¥)" + segments[segments.length - 1].segment;
};
```

#### è‡ªåŠ›ã§ã®æ”¹è¡Œä½ç½®æ”¹å–„

ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã«ãŠã‘ã‚‹è‡ªå‹•æ”¹è¡Œã®ä½ç½®ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã«ã‚‚ `Intl.Segmenter` ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

ç‰¹ã«æ—¥æœ¬èªãƒ»ä¸­å›½èªãƒ»éŸ“å›½èªãªã©ã® CJK è¨€èªã§ã¯å˜èªã®é€”ä¸­ã§æ”¹è¡Œã™ã‚‹ã¨èª­ã¿ã¥ã‚‰ããªã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå ´åˆã€å˜èªã®é€”ä¸­ã§æ”¹è¡Œã›ãšã«é©åˆ‡ãªä½ç½®ã§æ”¹è¡Œã™ã‚‹ãŸã‚ã« `Intl.Segmenter` ã® `granularity` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« `"word"` ã‚’æŒ‡å®šã—ã¦ã€å˜èªã®é€”ä¸­ã§æ”¹è¡Œã—ãªã„ã‚ˆã†ãªå‡¦ç†ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

```ts
const LINE_LIMIT = 30;
const breakTokLines = (text: string) => {
  const segmenter = new Intl.Segmenter("ja-JP", { granularity: "word" });
  const segments = [...segmenter.segment(text)];
  return segments.reduce(
    (acc, segment) => {
      if (acc.at(-1).length + segment.segment.length > LINE_LIMIT) {
        acc.push(segment.segment);
      } else {
        acc[acc.length - 1] += segment.segment;
      }
      return acc;
    },
    [""]
  );
};
breakTokLines(
  "ãƒ¡ãƒ­ã‚¹ã¯æ¿€æ€’ã—ãŸã€‚å¿…ãšã€ã‹ã®é‚ªæ™ºæš´è™ã®ç‹ã‚’é™¤ã‹ãªã‘ã‚Œã°ãªã‚‰ã¬ã¨æ±ºæ„ã—ãŸã€‚ãƒ¡ãƒ­ã‚¹ã«ã¯æ”¿æ²»ãŒã‚ã‹ã‚‰ã¬ã€‚"
);
// [
//     "ãƒ¡ãƒ­ã‚¹ã¯æ¿€æ€’ã—ãŸã€‚å¿…ãšã€ã‹ã®é‚ªæ™ºæš´è™ã®ç‹ã‚’é™¤ã‹ãªã‘ã‚Œã°ãªã‚‰ã¬",
//     "ã¨æ±ºæ„ã—ãŸã€‚ãƒ¡ãƒ­ã‚¹ã«ã¯æ”¿æ²»ãŒã‚ã‹ã‚‰ã¬ã€‚"
// ]
```

ãŸã ã—ã€[ä¸Šè¿°ã®è¨˜äº‹](https://zenn.dev/cybozu_frontend/articles/explore-intl-segmenter)ã§ã‚‚æ›¸ã„ãŸé€šã‚Š Intl.Segmenter ã«ãŠã‘ã‚‹æ—¥æœ¬èªã®å˜èªåˆ†å‰²ã¯å®Œç’§ã§ã¯ãªãã€ã‚ˆã‚Šé«˜ç²¾åº¦ãªåˆ†ã¡æ›¸ãå™¨ã‚‚å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚ãã¾ã§ã‚‚ç°¡æ˜“çš„ãªå®Ÿè£…ã¨è€ƒãˆãŸã»ã†ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

åˆ†ã¡æ›¸ãå™¨ã®ä¾‹ : [BudouX: èª­ã¿ã‚„ã™ã„æ”¹è¡Œã®ãŸã‚ã®è»½é‡ãªåˆ†ã‹ã¡æ›¸ãå™¨](https://developers-jp.googleblog.com/2023/09/budoux-adobe.html)

- github : https://github.com/google/budoux

## ã¾ã¨ã‚ã¨æ¬¡å›äºˆå‘Š

ã“ã®è¨˜äº‹ã§ã¯è¨€èªã‚’è€ƒæ…®ã—ãŸå˜èªã‚„è¦‹ãŸç›®ã®ï¼‘æ–‡å­—ã€æ–‡å˜ä½ã§æ–‡å­—åˆ—ã‚’åˆ†å‰²ã§ãã‚‹ `Intl.Segmenter` ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

æ¬¡å›[21 æ—¥ç›®]() ã§ã¯ Intl.Segmenter ã«æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ Intl.Segmenter v2 proposal ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

- JavaScript ã«ãŠã‘ã‚‹æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¨ã€Œæ–‡å­—æ•°ã€ã®æ•°ãˆæ–¹
  - https://blog.jxck.io/entries/2017-03-02/unicode-in-javascript.html
- UnicodeÂ® Standard Annex #29 Unicode Text Segmentation
  - https://unicode.org/reports/tr29/
